#!/bin/sh

export DATE="5.9.2005"
export TITLE="Verwaltung: WAN"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<script type="text/javascript">document.getElementById('idx55').className="idx selected";</script>

<H1>Verwaltung: WAN</H1>
EOF

if [ "$REQUEST_METHOD" = "POST" ]; then
read QUERY_STRING
fi
if [ -z "$QUERY_STRING" ]; then
#Speedups
wan_proto="$(nvram get wan_proto)"

	if [ -e /tmp/wan_error ]; then
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD colspan="2" class="error">$(cat /tmp/wan_error)
	</TD>
	</TR>
	</TBODY>
	</TABLE>
	<br><br>
EOF
	fi
	if [ -e /tmp/wan_warning ]; then
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD colspan="2" class="warning">$(cat /tmp/wan_warning)
	</TD>
	</TR>
	</TBODY>
	</TABLE>
	<br><br>
EOF
	fi

cat<<EOF
<FORM ACTION="wan.html" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form">
<TBODY>
<tr><td colspan="2"><b>Schnittstellen-Konfiguration</b></td></tr>
<TR
TITLE="Bestimmt die Betriebsart des Internet-Anschlusses (einzelne RJ45-Buchse). Ist PPPoE-Paket installiert, wird in der Betriebsart 'PPPoE' wird der PPPoE-Daemon automatisch gestartet.">
<TD>WAN-Protokoll:</TD>
<TD><SELECT NAME="wan_proto" ONCHANGE="this.form.wan_ipaddr.disabled=(0 != this.value.indexOf('static'));this.form.wan_netmask.disabled=(0 != this.value.indexOf('static'));this.form.wan_gateway.disabled=(0 != this.value.indexOf('static'));this.form.ppp_username.disabled=(0 != this.value.indexOf('pppoe'));this.form.ppp_passwd.disabled=(0 != this.value.indexOf('pppoe'));this.form.ppp_redialperiod.disabled=(0 != this.value.indexOf('pppoe'));this.form.ppp_idletime.disabled=(0 != this.value.indexOf('pppoe'));this.form.ppp_mtu.disabled=(0 != this.value.indexOf('pppoe'));">
<OPTION
VALUE='dhcp' $(test "$wan_proto" = "dhcp" && echo "selected=selected")>DHCP</OPTION>
<OPTION
VALUE='static' $(test "$wan_proto" = "static" && echo "selected=selected")>Statisch</OPTION>
<OPTION
VALUE='pppoe' $(test "$wan_proto" = "pppoe" && echo "selected=selected")>PPPoE</OPTION>
<OPTION
VALUE='disabled' $(test "$wan_proto" = "disabled" && echo "selected=selected")>Ausschalten</OPTION>
</SELECT> </TD>
</TR>
<TR
TITLE="Dies ist die IP-Adresse des Internet-Anschlusses (RJ45).">
<TD>WAN-IP:</TD>
<TD><INPUT NAME="wan_ipaddr" SIZE="32" TYPE="TEXT" VALUE="$(nvram get wan_ipaddr)"$(if [ "$wan_proto" != "static" ];then echo ' disabled="disabled"';fi)></TD>
</TR>

<TR
TITLE="Die Netzmaske bestimmt, welche drahtgebundenen IP-Adressen am Internet-Anschluss direkt erreicht werden können.">
<TD>WAN-Netzmaske:</TD>
<TD><INPUT NAME="wan_netmask" SIZE="32" TYPE="TEXT" VALUE="$(nvram get wan_netmask)"$(if [ "$wan_proto" != "static" ];then echo ' disabled="disabled"';fi)></TD>
</TR>

<TR
TITLE="Default-Route für den Internet-Anschluss.">
<TD>WAN Default-Route:</TD>
<TD><INPUT NAME="wan_gateway" SIZE="32" TYPE="TEXT" VALUE="$(nvram get wan_gateway)"$(if [ "$wan_proto" != "static" ];then echo ' disabled="disabled"';fi)></TD>
</TR>

<TR
TITLE="Benutzername für PPPoE">
<TD>PPP User:</TD>
<TD><INPUT NAME="ppp_username" SIZE="32" TYPE="TEXT" VALUE="$(nvram get ppp_username)"$(if [ "$wan_proto" != "pppoe" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR
TITLE="Passwort für PPPoE">
<TD>PPP Password:</TD>
<TD><INPUT NAME="ppp_passwd" SIZE="32" TYPE="TEXT" VALUE="$(nvram get ppp_passwd)"$(if [ "$wan_proto" != "pppoe" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR
TITLE="Einwahlwiederholung">
<TD>PPP Einwahlwiederholung:</TD>
<TD><INPUT NAME="ppp_redialperiod" SIZE="32" TYPE="TEXT" VALUE="$(nvram get ppp_redialperiod)"$(if [ "$wan_proto" != "pppoe" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR
TITLE="Idletime">
<TD>PPP Idletime:</TD>
<TD><INPUT NAME="ppp_idletime" SIZE="32" TYPE="TEXT" VALUE="$(nvram get ppp_idletime)"$(if [ "$wan_proto" != "pppoe" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR
TITLE="MTU">
<TD>PPP MTU:</TD>
<TD><INPUT NAME="ppp_mtu" SIZE="32" TYPE="TEXT" VALUE="$(nvram get ppp_mtu)"$(if [ "$wan_proto" != "pppoe" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<tr><td colspan="2">
<table class="form">
<TR><TD colspan="2">Hinweis: die DNS-Einstellungen sind global gültig.</td></tr>
EOF
	if [ -e /tmp/resolv.conf_ppp ]; then
		set_dns="none;"; pppoe_dns="block;"
	else
		set_dns="block;"; pppoe_dns="none;"
	fi
cat<<EOF
<TR style="display:$pppoe_dns">
	<TD colspan="2">
	aktuelle DNS-Server: $(nvram get lan_dns) (PPPoE)
	</TD>
</TR>
<TR style="display:$set_dns">
	<TD colspan="2">
	<INPUT CLASS="checkbox" NAME="on_autodns" TYPE="checkbox" $(test "$(nvram get on_autodns)" = "on" && echo "CHECKED='CHECKED'" && echo "VALUE='on'") ONCHANGE="var Number=1; this.form.lan_dns.disabled=this.checked;">Automatische Wahl der Gateways als DNS-Server
	</TD>
</TR>
<TR style="display:$set_dns"
TITLE="Diese Adresse wird angesprochen, um Internet-Namen mittels DNS in IP-Adressen aufzulösen.">
	<TD>DNS-Server:</TD>
	<TD><INPUT NAME="lan_dns" SIZE="32" TYPE="TEXT" VALUE="$(nvram get lan_dns)"$(test "$(nvram get on_autodns)" = "on" && echo "disabled='disabled'")></TD>
</TR>
<TR
TITLE="Ist diese Einstellung aktiviert, werden die bei der PPPOE-Einwahl übermittelten DNS-Server ignoriert">
	<TD COLSPAN="2"><INPUT CLASS="checkbox" NAME="on_pppoe_keepdns" TYPE="checkbox" $(test "$(nvram get on_pppoe_keepdns)" = "on" && echo "CHECKED='CHECKED'" && echo "VALUE='on'")>DNS-Server bei PPPoE-Einwahl nicht ändern</TD>
</TR>

</table></td></tr>
EOF
	if [ -e /usr/sbin/ez-ipupdate ]; then
cat<<EOF
<tr><td colspan="2">
<table class="form">
<tr><td colspan="2">
<b>Dynamischer IP DNS-Service</b><br />
(es müssen nicht alle Felder ausgefüllt werden)
</td></tr>
<TR>
	<TD>Service:</TD>
	<TD>
	<SELECT NAME="dyndns_service">
EOF
	service=$(awk 'BEGIN {FS="="} $1=="service-type" {print $2}' /etc/ez-ipupdate.conf)
	if [ -z "$service" ]; then service="dyndns"; fi
	ez-ipupdate -S dummy 2>&1 | awk 'BEGIN {RS=" "} $1 != "" {if(use) { res="<OPTION VALUE=\""$1"\""; if($1=="'$service'") res=res" SELECTED=\"true\""; res=res"\">"$1"</OPTION>"; print res}; if($1=="null"){ use=1;}}'
	user=$(awk 'BEGIN {FS="=|:"} $1=="user" {print $2}' /etc/ez-ipupdate.conf)
	pass=$(awk 'BEGIN {FS="=|:"} $1=="user" {print $3}' /etc/ez-ipupdate.conf)
	host=$(awk 'BEGIN {FS="="} $1=="host" {print $2}' /etc/ez-ipupdate.conf)
	server=$(awk 'BEGIN {FS="="} $1=="server" {print $2}' /etc/ez-ipupdate.conf)
	partner=$(awk 'BEGIN {FS="="} $1=="partner" {print $2}' /etc/ez-ipupdate.conf)
cat<<EOF
	</SELECT>
	</TD>
</TR>
<TR>
<TD>Nutzername:</TD>
<TD><INPUT NAME="dyndns_user" SIZE="32" TYPE="TEXT" VALUE="$user" {print $2}' /etc/ez-ipupdate.conf)"></TD>
</TR>
<TR>
<TD>Passwort:</TD>
<TD><INPUT NAME="dyndns_pass" SIZE="32" TYPE="TEXT" VALUE="$pass"></TD>
</TR>
<TR>
<TD>Hostname:</TD>
<TD><INPUT NAME="dyndns_host" SIZE="32" TYPE="TEXT" VALUE="$host"></TD>
</TR>
<TR>
<TD>Server:</TD>
<TD><INPUT NAME="dyndns_server" SIZE="32" TYPE="TEXT" VALUE="$server"></TD>
</TR>
<TR>
<TD>EasyDNS-Partner:</TD>
<TD><INPUT NAME="dyndns_partner" SIZE="32" TYPE="TEXT" VALUE="$partner"></TD>
</TR>
</table></td></tr>
EOF
	fi
cat<<EOF
<tr><td colspan="2"></td></tr>
<TR>
<TD COLSPAN="2"><INPUT NAME="post_wan" TITLE="Die Einstellungen übernehmen. Diese werden erst nach einem Neustart wirksam." TYPE="SUBMIT" VALUE="Übernehmen">   <INPUT NAME="post_abort" TITLE="Abbruch dieser Dialogseite" TYPE="SUBMIT" VALUE="Abbruch"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>

<br />
EOF
	if ! [ -e /usr/sbin/ez-ipupdate ]; then
cat<<EOF
<b>HINWEIS: </b> Wenn Du nach der Internet-Einwahl einen dynamischen IP DNS-Service nutzen willst, musst Du das <a href="webif/ipkg.sh?action=install&amp;pkg=ez-ipupdate">Paket ez-ipupdate installieren</a> (link startet Installation). Ist dieses nicht verfügbar, musst Du vorher die <a href="webif/ipkg.sh?action=update">Liste der verfügbaren Pakete aktualisieren</a>.<br />
<br />
EOF
	fi
else
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
DIRTY=
if [ -n "$post_wan" ]; then
	if [ -e /usr/sbin/ez-ipupdate ]; then
		if [ -e /etc/ez-ipupdate.conf ]; then mv -f /etc/ez-ipupdate.conf /etc/ez-ipupdate.conf_bak; fi
		echo "## ---------------- config written by wan.html -----" >/etc/ez-ipupdate.conf
		if [ -n "$dyndns_service" ]; then echo "service-type=$dyndns_service" >>/etc/ez-ipupdate.conf; fi
		if [ -n "$dyndns_user" ] || [ -n $dyndns_pass ]; then echo "user=$dyndns_user:$dyndns_pass" >>/etc/ez-ipupdate.conf; fi
		if [ -n "$dyndns_host" ]; then echo "host=$dyndns_host" >>/etc/ez-ipupdate.conf; fi
		if [ -n "$dyndns_server" ]; then echo "server=$dyndns_server" >>/etc/ez-ipupdate.conf; fi
		if [ -n "$dyndns_partner" ]; then echo "partner=$dyndns_partner" >>/etc/ez-ipupdate.conf; fi
		echo "## changed cache-file location to persist after reboot" >>/etc/ez-ipupdate.conf
		echo "cache-file=/etc/ez-ipupdate.cache" >>/etc/ez-ipupdate.conf
		echo "## ------------ end config written by wan.html -----" >>/etc/ez-ipupdate.conf
		echo >>/etc/ez-ipupdate.conf
		echo "## ---------------- rest of default config -------------" >>/etc/ez-ipupdate.conf
		if [ -e /etc/ez-ipupdate.conf_bak ]; then awk 'BEGIN {FS="="} $1 !~ "service-type|user|host|server|partner|cache-file|^##" {print}' /etc/ez-ipupdate.conf_bak >>/etc/ez-ipupdate.conf; fi
	fi
for V in wan_proto wan_ipaddr wan_netmask wan_gateway on_autodns lan_dns on_pppoe_keepdns ppp_username ppp_passwd ppp_redialperiod ppp_idletime ppp_mtu pppoe_keepdns; do

if [ "$V" != "wan_proto" ]; then
	if [ "$(nvram get wan_proto)" != "static" ]; then
		if [ "$V" = "wan_ipaddr" ] || [ "$V" = "wan_netmask" ] || [ "$V" = "wan_gateway" ]; then
			continue;
		fi;
	elif [ "$(nvram get wan_proto)" != "pppoe" ]; then
		if [ "$V" = "ppp_username" ] || [ "$V" = "ppp_passwd" ] || [ "$V" = "ppp_redialperiod" ] || [ "$V" = "ppp_idletime" ] || [ "$V" = "ppp_mtu" ]; then
			continue;
		fi;
	fi;
fi;
eval "C=\$$V"
C=$(unescape $C)
if [ "$V" = "lan_dns" ]; then
	if [ "$(nvram get on_autodns)" = "on" ]; then continue;
	else
		C="$(echo $C | awk '{gsub(","," ")} {print}')"
		rm -rf /tmp/resolv.conf
		for dns in $C; do
			logger -t "wan.htm" "replacing /tmp/resolv.conf"
			echo "nameserver $dns" >> /tmp/resolv.conf
		done
	fi;
fi;
if [ "$C" != "$(nvram get $V)" ]; then
DIRTY=1
nvram set $V="$C"
fi
done
fi
if [ -n "$DIRTY" ]; then
wan_ifname="$(nvram get wan_ifname)"
if [ "$wan_proto" = "pppoe" ]; then
	if [ "$wan_ifname" != "ppp0" ]; then
		# nvram set pppoe_ifname="$wan_ifname";
		nvram set wan_device="$wan_ifname";
		nvram set wan_ifname="ppp0";
		
		# setze maxfail bei /etc/ppp/options auf 0 (wenn noch nicht vorhanden)
		if [ -z "$(grep maxfail /etc/ppp/options)" ]; then
			if [ -h /etc/ppp/options ]; then cp -f /etc/ppp/options /etc/ppp/options; fi;
			echo "maxfail 0" >>/etc/ppp/options;
		fi
	fi;
else
	if [ "$wan_ifname" = "ppp0" ]; then
		nvram set wan_ifname="$(nvram get wan_device)";
		# nvram unset pppoe_ifname;
	fi;
fi;	
nvram commit>/dev/null 2>&1
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Die ge&auml;nderten Einstellungen wurden &uuml;bernommen.
Die Einstellungen sind erst beim n&auml;chsten <A HREF="reset.html">Neustart</A>
aktiv.</TD>
</TR></TBODY>
</TABLE>
EOF

else

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Es wurden keine Einstellungen ge&auml;ndert. Wurden Einstellungen des dynamischen IP DNS-Service geändert, werden diese bei der nächsten (Re)Aktivierung des WAN-Anschlusses benutzt.</TD>
</TR></TBODY>
</TABLE>
EOF

fi
fi

. ${0%/*}/cgi-bin-post.sh
