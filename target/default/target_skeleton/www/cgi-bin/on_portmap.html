#!/bin/sh

export DATE="2.9.2005"
export TITLE="Verwaltung: Portmapping"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<H1>Verwaltung: Portmapping</H1>
<p>Die folgenden Ports werden aus dem Internet durch einen aktivem OpenVPN-Tunnel an Rechner im lokalen Netzwerk weitergeleitet. Sie sind vom Internet über den Rechnernamen <b>opennet.dnsalias.org</b> zu erreichen.</p>
EOF
if [ "$REQUEST_METHOD" = "POST" ]; then
	read QUERY_STRING
fi
if [ -z "$QUERY_STRING" ]; then
	base_addr=$((10000+10*($(nvram get wifi_ipaddr | cut -d'.' -f4)-1)))
cat<<EOF
	<FORM NAME="MAINFORM" ACTION="on_portmap.html" CLASS="form" METHOD="POST">
	<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form">
	<TBODY>
	<TR><TD colspan="2">
	<INPUT CLASS="checkbox" NAME="on_mapall2one" TYPE="checkbox" $(test "$(nvram get on_mapall2one)" = "true" && echo "CHECKED='true'" && echo "VALUE='true'") ONCHANGE="this.value=this.checked; this.form.on_mapaddr1.disabled=('true' == this.value);this.form.on_mapaddr2.disabled=('true' == this.value);this.form.on_mapaddr3.disabled=('true' == this.value);this.form.on_mapaddr4.disabled=('true' == this.value);this.form.on_mapaddr5.disabled=('true' == this.value);this.form.on_mapaddr6.disabled=('true' == this.value);this.form.on_mapaddr7.disabled=('true' == this.value);this.form.on_mapaddr8.disabled=('true' == this.value);this.form.on_mapaddr9.disabled=('true' == this.value);">Alle Ports an einen Zielrechner weiterleiten
	</TD></TR>
	
	<TR><TD><B>Port</B></TD><TD>zu <B>IP-Adresse</B></TD>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>Alle Ports bzw. $((base_addr))</TD>
	<TD><INPUT NAME="on_mapaddr0" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr0)"></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+1))</TD>
	<TD><INPUT NAME="on_mapaddr1" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr1)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+2))</TD>
	<TD><INPUT NAME="on_mapaddr2" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr2)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+3))</TD>
	<TD><INPUT NAME="on_mapaddr3" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr3)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+4))</TD>
	<TD><INPUT NAME="on_mapaddr4" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr4)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+5))</TD>
	<TD><INPUT NAME="on_mapaddr5" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr5)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+6))</TD>
	<TD><INPUT NAME="on_mapaddr6" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr6)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+7))</TD>
	<TD><INPUT NAME="on_mapaddr7" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr7)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+8))</TD>
	<TD><INPUT NAME="on_mapaddr8" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr8)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR TITLE="Gib die Adresse ein, auf die der Port gemappt werden soll.">
	<TD>$((base_addr+9))</TD>
	<TD><INPUT NAME="on_mapaddr9" SIZE="34" TYPE="TEXT" VALUE="$(nvram get on_mapaddr9)"$(test "$(nvram get on_mapall2one)" = "true" && echo "disabled='true'")></TD>
	</TR>
	<TR>
	<TD COLSPAN="3"><INPUT NAME="post_on_portmap" TITLE="Die Einstellungen übernehmen. Diese werden erst nach einem Neustart wirksam." TYPE="SUBMIT" VALUE="Übernehmen">   <INPUT NAME="post_abort" TITLE="Abbruch dieser Dialogseite" TYPE="SUBMIT" VALUE="Abbruch"></TD>
	</TR></TBODY>
	</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE>
	</FORM>
EOF
	
else
	eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
	DIRTY=
	if [ -n "$post_on_portmap" ]; then
		for V in on_mapaddr0 on_mapaddr1 on_mapaddr2 on_mapaddr3 on_mapaddr4 on_mapaddr5 on_mapaddr6 on_mapaddr7 on_mapaddr8 on_mapaddr9 on_mapall2one; do
			eval "C=\$$V"
			C=$(unescape $C)
			if [ "$C" != "$(nvram get $V)" ]; then
				if [ -z "$DIRTY" ]; then
					echo -n "<PRE>"
					/etc/init.d/S82portmapping stop
					echo "</PRE>"
				fi
				DIRTY=1
				nvram set $V="$C"
			fi
		done
	fi
	if [ -n "$DIRTY" ]; then
		nvram commit>/dev/null 2>&1
cat<<EOF
		<TABLE BORDER="0" CLASS="note">
		<TBODY>
		<TR>
		<TD>Die ge&auml;nderten Einstellungen wurden &uuml;bernommen.
		Portmapping wird nun aktualisiert</TD>
		</TR></TBODY>
		</TABLE>
EOF
		echo -n "<PRE>"
		/etc/init.d/S82portmapping start
		echo "</PRE>"
	else
cat<<EOF
		<TABLE BORDER="0" CLASS="note">
		<TBODY>
		<TR>
		<TD>Es wurden keine Einstellungen ge&auml;ndert.</TD>
		</TR></TBODY>
		</TABLE>
EOF
	fi
fi

. ${0%/*}/cgi-bin-post.sh
