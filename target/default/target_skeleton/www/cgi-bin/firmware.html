#!/bin/sh

export DATE="5.9.2005"
export TITLE="Verwaltung: Firmware"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<H1>Verwaltung: Firmware</H1>
EOF

if [ "$REQUEST_METHOD" = "POST" ]; then
read QUERY_STRING
fi
if [ -z "$QUERY_STRING" ]; then

if [ -f /etc/openvpn/on_aps.key ]; then
cat<<EOF
<H2>ACHTUNG: Firmware-update nicht möglich</H2>
<b>Auf dem Rechner befindet sich noch ein geheimer Schlüssel.</b> Diesen kannst du unter dem Punkt <a href="on_vpn.html">OpenVPN</a> herunterladen. Speicher diesen, aber <b>auch dein öffentliches Zertifikat</b>, an einem sicheren Ort. Erst wenn der geheime Schlüssel von diesem Rechner gelöscht ist, kannst du die Firmware aktualisieren.<br><br>
Das <b>Löschen des geheimen Schlüssels</b> auf diesem Accesspoint bestätigst du mit dem Heraufladen deines geheimen Schlüssels.<br>
<br>
<FORM ACTION="firmware_remove_key.html" ENCTYPE="multipart/form-data" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Wähle deinen geheimen Schlüssel (*.key) und lade ihn hoch">
<TBODY>
<TR>
<TD colspan="2">Geheimen Schlüssel (*.key) zur Bestätigung des Löschvorgangs auf den Accesspoint laden</TD>
</TR>
<TR>
<TD><INPUT NAME="opensslfile" SIZE="32" TYPE="FILE" VALUE="Durchsuchen..."></TD>
<TD><INPUT NAME="remove_key" TITLE="Stimmt der hochgeladene Schlüssel mit deinem geheimen Schlüssel auf dem AccessPoint überein, wird dieser auf dem Accesspoint gelöscht" TYPE="SUBMIT" VALUE="geheimen Schlüssel auf dem Accesspoint löschen"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
EOF
else
cat<<EOF
<H2>WARNUNG: Ein Firmware-update kann deinen Router zerstören.</H2>
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Wichtig falls das Firmware-update fehlschlägt:
<ul>
<li>ASUS: Unbedingt die Adresse des Routers im lokalen Netzwerk<b>
EOF
echo $(nvram get lan_ipaddr)
cat<<EOF
</b>aufschreiben. Wenn das firmware-update fehlschlägt, ist der Router vielleicht nur unter dieser Adresse (und nicht unter 192.168.1.1) erreichbar.
</li>
EOF
if [ $(nvram get boot_wait) != "on" ]; then
	echo "<li>Option boot_wait ist nicht aktiviert. Aus Sicherheitsgründen ;) wird diese Option bei einem firmware-update automatisch gesetzt.</li>"
fi
cat<<EOF
</ul>
<b>Wenn ihr auf Firmware laden drückt, wird nicht mehr nachgefragt!</b>
</TD>
</TR></TBODY>
</TABLE><br>

<FORM ACTION="firmware.html" ENCTYPE="multipart/form-data" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Wähle eine Firmware-Datei. Die Opennet-Firmware kann nur als *.trx-Datei geladen werden.">
<TBODY>
<TR>
<TD>Firmware-Datei (*.trx):</TD>
</TR>
<TR>
<TD><INPUT NAME="firmfile" SIZE="60" TYPE="FILE" VALUE="Durchsuchen..."></TD>
</TR>
<TR>
<TD> </TD>
</TR>
<TR>
<TD><INPUT NAME="post_firm" TITLE="Die ausgewählte Firmware-Datei übertragen und dann sofort in den Flash-Speicher des Gerätes 'einbrennen'." TYPE="SUBMIT" VALUE="Firmware laden" CLASS="note">   <INPUT NAME="post_abort" TITLE="Abbruch dieser Dialogseite" TYPE="SUBMIT" VALUE="Abbruch"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
Diese opennet-Version des Firmware-Updates kann nur mit Herstellerunabhängigen *.trx-Dateien umgehen. Andere kannst du an dieser Stelle nicht hochladen.

EOF
fi
elif ! ffout=$(./freifunk-upload 2>&1); then

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>$ffout</TD>
</TR></TBODY>
</TABLE>

<P>Der Ladevorgang wurde abgebrochen.</P>
EOF

elif  [ -n "$ffout" ]; then
	MAGIC=$(dd if="$ffout" bs=4 count=1 2>/dev/null)
	if [ "HDR0" = "$MAGIC" ]; then

cat<<EOF
		<TABLE BORDER="0" CLASS="note">
		<TBODY>
		<TR>
		<TD>Schreibe die Firmware-Datei $ffout in den
		Flash-Speicher. Bitte warten...</TD>
		</TR></TBODY>
		</TABLE><IMG
		ALT="164 Sekunden..."
		HEIGHT="8" SRC="../images/progress270.gif" VSPACE="10" WIDTH="255" TITLE="270 Sekunden...">
		
		<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript"><!--
		setTimeout("location.href=('192.168.1.1'==location.hostname?'http://$(nvram get lan_ipaddr)/':'/')", 270000);
		//--></SCRIPT>
EOF
		echo -n "<PRE>"
		if [ $(nvram get boot_wait) != "on" ]; then
			echo "setze boot_wait auf on"
			nvram set boot_wait=on
			nvram commit
		fi		
		echo "Neue Firmware wird installiert. Hab etwas Geduld, das kann durchaus einige Minuten (etwa 5) dauern."
		echo "(Der Fortschrittsbalken ist nicht direkt mit dem Update-Vorgang gekoppelt - Fehler in der Darstellung sind nicht mit Fehlern im Update-Vorgang gleichzusetzen, bitte einfach weiterwarten)"
		mtd -e linux -r write $ffout linux &>/dev/null
		echo "</PRE>"
	else
		rm -f "$ffout"

cat<<EOF
		<TABLE BORDER="0" CLASS="note">
		<TBODY>
		<TR>
		<TD>Firmware-Datei hat falsches Format.</TD>
		</TR></TBODY>
		</TABLE>
		
		<P>Bitte eine passende *.trx-Firmware-Datei
		laden.</P>
EOF

	fi
else

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Keine Datei empfangen.</TD>
</TR></TBODY>
</TABLE>

<P>Der Vorgang wurde nicht ausgef&uuml;hrt.</P>
EOF

fi

. ${0%/*}/cgi-bin-post.sh
