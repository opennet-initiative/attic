#!/bin/sh

export DATE="28.5.2005"
export TITLE="Verwaltung: Webseiten"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<H1>Verwaltung: Webseiten</H1>
EOF

if [ "$REQUEST_METHOD" != "POST" ]; then

cat<<EOF
<FORM ACTION="webpages.html" ENCTYPE="multipart/form-data" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Wähle ein *.tar, *.tgz oder *.tar.gz-Archiv mit den neuen Webseiten.">
<TBODY>
<TR>
<TD>Webseiten-Archiv (*.tar):</TD>
</TR>
<TR>
<TD><INPUT NAME="webfile" SIZE="32" TYPE="FILE" VALUE="Durchsuchen..."></TD>
</TR>
<TR>
<TD> </TD>
</TR>
<TR>
<TD><INPUT NAME="post_web" TITLE="Die ausgewählte Webseiten-Datei übertragen und dann sofort veröffentlichen." TYPE="SUBMIT" VALUE="Webseiten laden">   <INPUT NAME="post_abort" TITLE="Abbruch dieser Dialogseite" TYPE="SUBMIT" VALUE="Abbruch"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>

<H2>Eigene Webseiten erstellen</H2>

<P>Mit dem Mikro-Autorensystem dieser Firmware ist es
recht einfach, die Webseiten dieses Ger&auml;tes zu &auml;ndern oder neue
hinzuzuf&uuml;gen. F&uuml;r das Betriebssystem Windows m&uuml;ssen zwei
Programme installiert werden: Die Skriptsprache
<A HREF="http://www.perl.org/">Perl</A> und ein Archivprogramm zum
Erzeugen von TAR-Archiven (z.B. <A HREF="http://www.ultimatezip.de/">UltimateZip</A>).
Mit einem Standard-Linux sind diese Programme bereits installiert.</P>

<H3>Funktionsweise</H3>

<P>Ein Perl-Skript (template.pl) liest eine HTML-Datei
(template.html) als Vorlage ein und sucht die Zeichenkette &quot;%BODY%&quot;.
Danach liest das Perl-Skript nacheinander alle anderen HTML-Dateien im
Verzeichnis ein und extrahiert den Teil zwischen &lt;BODY&gt; und &lt;/BODY&gt;.
Der extrahierte HTML-Teil wird in das Template an die Stelle %BODY% eingef&uuml;gt
und das Ergebnis in ein neues Verzeichnis (./out-de/) geschrieben. </P>

<P>Referenzierte Dateien (z.B. Bilder) kopiert das
Perl-Skript ebenfalls in das neue Verzeichnis. Die Zeichenkette &quot;$(echo -n %)DATE%&quot; wird durch den Datumsstempel der Quelldatei ersetzt. Die
Zeichenkette &quot;$(echo -n %)TITLE%&quot; wird durch die erste H1-&Uuml;berschrift
der Quelldatei ersetzt.</P>

<P>Beginnt der Dateiname der Quelldatei mit &quot;cgi-bin&quot;,
werden Shell-Kommandos f&uuml;r die Ausf&uuml;hrung durch den Webserver
eingesetzt. Eigene Shell-Kommandos kann man zwischen &lt;SCRIPT LANGUAGE=&quot;shell&quot;&gt;&lt;/SCRIPT&gt;
in die Quelldatei schreiben. Bei der Ausf&uuml;hrung durch den Web-Server
werden Shell-Variablen aufgel&ouml;st. Beispiele: &quot;\$PWD&quot; wird
als $PWD ausgegeben, &quot;\$(ls /tmp)&quot; listet den Inhalt des
Verzeichnisses /tmp. </P>

<P LANG="s">Das Ausgabeverzeichnis (./out-de/) kann mit
allen Unterverzeichnissen in ein TAR-, TGZ- oder TAR.GZ-Archiv gepackt
werden. Die Archiv-Datei kann danach &uuml;ber diese Verwaltungs-Seite &uuml;bertragen
werden. Vorhandene Seiten (z.B. die Verwaltungs-Seiten) werden durch
diesen Vorgang nicht gel&ouml;scht.</P>

<H3>Kurzanleitung</H3>

<OL>
<LI>Lade das Autorenpaket <A HREF="ff-web.tar">ff-web.tar</A>
von diesem Ger&auml;t.</LI>
<LI>Extrahiere die Dateien in ein neues Verzeichnis
(Linux: &quot;tar -xvf ff-web.tar&quot;).</LI>
<LI>Starte das Perl-Skript: (Linux: &quot;cd ff-web;
perl template.pl de; ls out-de&quot;).</LI>
<LI>Erstelle eine Archivdatei von dem Ausgabeverzeichnis
(Linux: &quot;tar -cvf out-de.tar out-de&quot;).</LI>
<LI>&Uuml;bertrage die neue Archiv-Datei out-de.tar mit
dieser Verwaltungs-Seite.</LI>
<LI>&Auml;ndere die HTML-Quelldateien und Wiederhole ab
Schritt 3.</LI>
</OL>

<P><B>Hinweis</B>: Im Autorenpaket sind 2 symbolische
Links nicht enthalten, die aber auf dem Ger&auml;t unter /www vorhanden
sind. Die Ausgabe &quot;No ./netperf, No ./netserver&quot; ist normal und
weist auf diese Tatsache hin.</P>

<P><B>Hinweis f&uuml;r Windows-Benutzer</B>: Sind die
Programme &quot;tar&quot; und &quot;perl&quot; installiert, k&ouml;nnen
die Linux-Befehle in der Windows-Eingabeaufforderung eingegeben werden.
Ersetze das Zeichen &quot;/&quot; durch den Backslash (&quot;\&quot;). Das
Perl-Script kann auch per Doppelklick auf den Dateinamen &quot;template.pl&quot;
gestartet werden.</P>

<H3>Tipps</H3>

<P>Schreibe g&uuml;ltiges HTML und beende offene &lt;Tags&gt;
mit &lt;/Tags&gt;. Verwende dazu am besten einen validierenden HTML-Editor
oder einen Text-Editor und etwas Disziplin.</P>

<P>F&uuml;ge einen Verweis auf eine neue Seite zur Datei
template.html hinzu. Kopiere eine der vorhandenen Tabellenzeilen (z.B. &lt;TR&gt;...
Status ...&lt;/TR&gt;) und &auml;ndere das Tag &lt;A HREF=&quot;&quot;&gt;
und den Text. M&ouml;glicherweise muss die linke Navigations-Spalte
breiter werden. Suche und &auml;ndere WIDTH=&quot;150&quot; auf die gew&uuml;nschte
Breite.</P>

<P>Ein neues Unterverzeichnis ben&ouml;tigt auch eine neue
template.html. Diese wird durch das Perl-Skript gefunden und f&uuml;r
jedes Unterverzeichnis extra eingelesen. Um Platz zu sparen, sollten
Referenzen zu vorhandenen Grafiken auf &quot;../images/&quot; umgebaut
werden.</P>

<P>Das TAR-Archiv wird vor dem Laden untersucht, um m&ouml;glicherweise
vorhandene Unterverzeichnisebenen in der Archivdatei zu k&uuml;rzen.</P>

<P>Mehrere Sprachen k&ouml;nnen mit &lt;SPAN LANG=&quot;xx&quot;&gt;
nebeneinander geschrieben werden. Au&szlig;erdem werden TITLE-, ALT- und
VALUE-Attribute nach dem Muster &quot;Alle Sprachen!xx:Text f&uuml;r
Sprache A!yy:Text f&uuml;r Sprache B&quot; ausgewertet. Das Perl-Skript
kann mit einem Parameter f&uuml;r die auszugebende Sprache aufgerufen
werden.</P>
EOF

elif ! ffout=$(./freifunk-upload 2>&1); then

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>$ffout</TD>
</TR></TBODY>
</TABLE>

<P>Der Webseiten-Ladevorgang wurde abgebrochen.</P>
EOF

elif [ -n "$ffout" ]; then

cat<<EOF
<P>Der Webseiten-Ladevorgang wird ausgef&uuml;hrt.</P>
EOF

echo "<PRE>"
mkdir /tmp/wwwtmp.$$
zflag=
if [ -z "${ffout##*.tar.gz}" ] || [ -z "${ffout##*.tgz}" ]; then
zflag=-z
fi
tardir=$(tar $zflag -tvf "$ffout" | awk '/^-/ {exit} /^d/ {print $6;exit}')
mkdir /tmp/wwwtmp.$$/
tar -C /tmp/wwwtmp.$$/ $zflag -xf "$ffout"
rm -f "$ffout"
chown -R root:root /tmp/wwwtmp.$$/
chmod +x /tmp/wwwtmp.$$/$tardir/cgi-bin*>/dev/null 2>&1
chmod +x /tmp/wwwtmp.$$/$tardir/cgi-bin/*>/dev/null 2>&1
tar -cC "/tmp/wwwtmp.$$/$tardir" .| tar -xvC /www/
rm -rf /tmp/wwwtmp.$$/
echo "</PRE>"
else

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Kein Webseiten-Archiv empfangen.</TD>
</TR></TBODY>
</TABLE>

<P>Der Webseiten-Ladevorgang wurde nicht ausgef&uuml;hrt.</P>
EOF

fi

. ${0%/*}/cgi-bin-post.sh
