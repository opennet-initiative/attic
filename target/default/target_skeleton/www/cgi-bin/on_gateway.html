#!/bin/sh

export DATE="9.12.2005"
export TITLE="Verwaltung: Opennet"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<H1>Verwaltung: OpenVPN-Gateways</H1>
EOF

if [ "$REQUEST_METHOD" = "POST" ]; then
	read QUERY_STRING
fi
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')

if [ -n "$add_gw" ]; then
	nvram set on_gwauto="$on_gwauto"
	if [ "$on_gwauto" != "on" ]; then
		number=1
		on_gwaddrs_new=
		for on_gwaddr in $(nvram get on_gwaddrs); do
			on_gwaddrs_new="$on_gwaddrs_new "$(eval echo \$on_gw$number)
			number=$(($number+1))
		done;
		on_gwaddrs_new=$(echo $on_gwaddrs_new)
		nvram set on_gwaddrs="$on_gwaddrs_new $on_gwtoadd"
	else
		# refresh gateway values
		/usr/sbin/cron.minutely_ongateway refresh
	fi
elif [ -n "$add_blackgw" ]; then
	number=1
	on_gwblackaddrs_new=
	for on_gwblackaddr in $(nvram get on_gwblackaddrs); do
		on_gwblackaddrs_new="$on_gwblackaddrs_new "$(eval echo \$on_gwblack$number)
		number=$(($number+1))
	done;
	on_gwblackaddrs_new=$(echo $on_gwblackaddrs_new)
	nvram set on_gwblackaddrs="$on_gwblackaddrs_new $on_gwblacktoadd"
	if [ "$on_gwauto" = "on" ]; then
		# refresh gateway values and remove possible blacklisted entrys
		/usr/sbin/cron.minutely_ongateway refresh
	fi
elif [ -n "$openvpn_restart" ]; then
	nvram set on_gwcount=10		# force not to wait before changing the gateway
	echo -n "<br />..."
	/usr/sbin/cron.minutely_ongateway
	echo -n "...<br /><br />"
	nvram set on_gwcount=0
fi


gwauto=$(nvram get on_gwauto)

cat<<EOF

In diesem Bereich können die IP-Adressen der von euch gewünschten OpenVPN-Gateways eingetragen werden. Falls ihr euch über aktuelle Gateways im Opennet informieren wollt, schaut im <a href="http://wiki.opennet-initiative.de/index.php/Opennet_Nodes#Gateways">Opennet-Wiki</a> nach. Als Gateway wird der jeweils erste eingetragene Gateway genutzt, zu dem eine Route führt. Ein Wechsel der Gateways erfolgt, wenn der aktuelle Gateway etwa 6 Minuten lang nicht der erste erreichbare Gateway entsprechend der Liste ist. <b>Achtung:</b> Ein Wechsel des Gateways führt zur Unterbrechung aller aktiven Internetverbindungen.
<br /><br />
Sind keine Gateways aus dieser Liste erreichbar,  (oder ist die Liste leer), ist OpenVPN deaktiviert . Falls Gateways ohne OpenVPN im Opennet aktiv sind, werden diese dann automatisch genutzt. 
<br /><br />
<b>Automatische Gateway-Suche:</b> Die Gateways werden automatisch ermittelt und anhand ihrer Entfernung (HOP-Count) sortiert. Dies muss nicht in allen Fällen optimal sein.
<br /><br />
<FORM ACTION="on_gateway.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Gateway Konfiguration">
<TBODY>
<TR><TD colspan="3">
	<INPUT CLASS="checkbox" NAME="on_gwauto" TYPE="checkbox" $(test "$gwauto" = "on" && echo "CHECKED='on'" && echo "VALUE='on'") ONCHANGE="var Number=1; while(eval('this.form.on_gw'+Number)) {eval('this.form.on_gw'+Number++).disabled=this.checked;}; this.form.on_gwtoadd.disabled=this.checked;">Automatische Gateway-Suche
	</TD></TR>
<TR><TD colspan="3"><HR /></TD></TR>
<TR>
<TD></TD>
<TD><b>IP-Adresse</b></TD>
<TD><b>Erreichbarkeit</b></TD>
</TR>
EOF
change=
reachable=0
number=1
gw_reachable="no"
for on_gwaddr in $(nvram get on_gwaddrs); do
cat<<EOF
<TR>
	<td>$number. </td>
	<td NAME="address"><INPUT NAME="on_gw$number" SIZE="20" TYPE="TEXT" VALUE="$on_gwaddr" $(test "$gwauto" = "on" && echo "DISABLED='1'")></td>
	<td> 
EOF
	blacklisted=
	for on_gwblackaddr in $(nvram get on_gwblackaddrs); do
		if [ "$on_gwblackaddr" = "$on_gwaddr" ]; then
			blacklisted="true"
			continue;
		fi
	done

	if  [ "$(route -n | cut -d" " -f1 | grep $on_gwaddr)" = "$on_gwaddr" ]; then
		echo "<img src=\"../images/yes.gif\" alt=\"yes\">"
		if [ -z "$blacklisted" ]; then reachable=$(($reachable+1)); fi
	else	
		echo "<img src=\"../images/no.gif\" alt=\"no\">"
	fi
	
	if [ "$(nvram get on_gw)" = "$on_gwaddr" ]; then
		gw_reachable="yes"
		if [ -f  /tmp/openvpn_msg.txt ];then
			echo "Tunnel aktiv "
		else
			echo "Tunnel startend "
		fi
		if [ "$reachable" != "1" ] || [ -n "$blacklisted" ]; then change="yes"; fi
	fi

	if  [ -n "$blacklisted" ]; then echo "* GW gesperrt *"; fi

	echo "</td>"
	number=$(($number+1))
	echo "</TR>"
done

if [ "$gw_reachable" = "no" ] && [ "$reachable" != "0" ]; then
	change="yes";
fi

cat<<EOF

<TR>
<TD> </TD>
</TR><TR>
	<td colspan="3">Gateway hinzufügen:</td>
</TR>
</TR>
	<td></td><td><INPUT NAME="on_gwtoadd" SIZE="20" TYPE="TEXT" VALUE="" $(test "$gwauto" = "on" && echo "DISABLED='1'")></td>
</TR>
<TR><TD colspan="3"><HR /></TD></TR>
<TR>
<TD></TD><TD colspan="3"><INPUT NAME="add_gw" TITLE="OpenVPN-Gateway-Liste aktualisieren" TYPE="SUBMIT" VALUE="Einträge übernehmen / Auto-Modus festlegen"></TD>
</TR>
</TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE>

<H2>Gateway-Blacklist</H2>
An dieser Stelle kannst Du gezielt einzelne Gateways sperren. Auch wenn diese in der Liste oben auftauchen, werden die Rechner aus der Blacklist nicht berücksichtigt. (Über welchen Rechner eine Verbindung ins Internet ohne OpenVPN - wenn überhaupt - hergestellt wird, kann hierdurch allerdings nicht beeinflusst werden)
<FORM ACTION="on_gateway.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Gateway Blacklist">
<TBODY>
<TR>
<TD></TD>
<TD><b>IP-Adresse</b></TD>
<TD><b>Erreichbarkeit</b></TD>
</TR>
EOF
number=1
for on_gwblackaddr in $(nvram get on_gwblackaddrs); do
cat<<EOF
<TR>
	<td>$number. </td>
	<td NAME="address"><INPUT NAME="on_gwblack$number" SIZE="20" TYPE="TEXT" VALUE="$on_gwblackaddr"></td>
	<td> 
EOF
	if  [ "$(route -n | cut -d" " -f1 | grep $on_gwblackaddr)" = "$on_gwblackaddr" ]; then
		echo "<img src=\"../images/yes.gif\" alt=\"yes\">"
	else	
		echo "<img src=\"../images/no.gif\" alt=\"no\">"
	fi
	
	echo "</td>"
	number=$(($number+1))
	echo "</TR>"
done
cat<<EOF

<TR>
<TD> </TD>
</TR><TR>
	<td colspan="3">Gateway zur Blacklist hinzufügen:</td>
</TR>
</TR>
	<td></td><td><INPUT NAME="on_gwblacktoadd" SIZE="20" TYPE="TEXT" VALUE=""></td>
</TR>
<TR><TD colspan="3"><HR /></TD></TR>
<TR>
<TD></TD><TD colspan="3"><INPUT NAME="add_blackgw" TITLE="OpenVPN-Gateway-Blacklist aktualisieren" TYPE="SUBMIT" VALUE="Einträge übernehmen"></TD>
</TR>
</TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE>


EOF
if [ "$change" = "yes" ] && [ "$reachable" != "0" ] ; then

wait=$((6-$(nvram get on_gwcount)))

cat<<EOF
<br /><br />
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Der erste erreichbare und nicht gesperrte Gateway ist im Moment nicht der aktive Gateway. Der Tunnel wird in etwa $wait Minuten neu gestartet. Die Veränderungen sind dann bei einer <a href="on_gateway.html">Aktualisierung dieser Seite</a> zu sehen.</TD>
</TR>
<TR>
<TD><INPUT NAME="openvpn_restart" TITLE="Starte Tunnel sofort neu" TYPE="SUBMIT" VALUE="Tunnel sofort neu starten / Gateway sofort wechseln"></TD></TR>
</TBODY>
</TABLE>
EOF

fi
cat<<EOF
</FORM>
EOF


nvram commit

. ${0%/*}/cgi-bin-post.sh
