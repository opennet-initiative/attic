#!/bin/sh
_version=$(nvram get on_fw_version)
if [ -z "${_version##*RC6*}" ]; then upgrade="system-upgrade.sh"; upgrade_bak=$upgrade"_bak"
else upgrade="upgrade.sh"; upgrade_bak=$upgrade"_bak";
fi

export DATE="15.8.2005"
export TITLE="Verwaltung: Internet-Freigabe"
. ${0%/*}/cgi-bin-pre.sh

cat<<EOF
<script type="text/javascript">document.getElementById('idx17').className="idx selected";</script>

<H1>Verwaltung: Internet-Freigabe</H1>
EOF

if [ "$REQUEST_METHOD" = "POST" ]; then
read QUERY_STRING
fi
if [ -z "$QUERY_STRING" ]; then

# presets (if set, user will not be able to change the value)
# those values are repeated on bottom (this is not nice, I know)
openssl_countryName="de"
openssl_provinceName="Mecklenburg-Vorpommern"
openssl_localityName="Rostock"
openssl_organizationalUnitName="user gateways"

on_share_internet="$(nvram get on_share_internet)"
on_share_internet_blocked="$(nvram get on_share_internet_blocked)"

cat<<EOF
In diesem Bereich kannst Du Deinen Breitband-Anschluss für Opennet-Mitglieder zur Nutzung freigeben.<br />
<!-- show the following area only, if user likes more information -->
<a id="switch1" href="#" onclick="document.getElementById('description1').style.display='inline';this.style.display='none';" style="display:none;">mehr Informationen.</a>
<div id="description1">
<br />
Wenn Du selbst einen Breitband-Anschluss besitzt, kannst Du diesen hier für die Nutzung im Opennet freigeben. Die Verbindung zum Breitband-Anschluss muss dabei über die WAN-Buchse deines AccessPoint hergestellt werden. Wenn Du DSL nutzt, kannst den AP auch für die Einwahl ins Internet nutzen (siehe <a href="wan.html">WAN</a>)<br />
Für die Freigabe Deines Breitband-Anschlusses wird ein Tunnel zwischen Deinem AccessPoint und einem zentralen Opennet-Gateway (bspw. nagare.on-i.de) über das Internet aufgebaut. Dieser Gateway ist dadurch direkt mit Deinem AccessPoint verbunden und wird so Teil des Opennet. Alle Nutzer, die Deinen AP erreichen, können somit auch den zentralen Opennet-Gateway erreichen und zu diesem, wie zu allen Vereinsgateways, einen Nutzer-Tunnel aufbauen.<br />
Um einen zentralen Gateway einzubinden (und somit Internet freizugeben) musst Du also (genauso wie wenn Du aktiver Nutzer bist) zuerst einen Schlüssel und eine Zertifikatanfrage generieren.
</div>
<script type="text/javascript">
	document.getElementById('switch1').style.display='inline';
	document.getElementById('description1').style.display='none';
</script>
<!-- ************************************************************ -->
<br />
EOF
if [ -z "$on_share_internet_blocked" ] && [ "$on_share_internet" = "on" ] && [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ] && [ -n  "$(ip route show table 5)" ]; then
cat<<EOF
<H2>Vorübergehende Deaktivierung</H2>
<!-- show the following area only, if user likes more information -->
<a id="switch2" href="#" onclick="document.getElementById('description2').style.display='inline';this.style.display='none';" style="display:none;">Erklärung</a>
<div id="description2">
Hier kannst Du für eine von Dir wählbare Zeit - maximal einen Tag - deine Internetfreigabe vorübergehend deaktivieren. Nach Ablauf dieser Zeit wird - wie zu erwarten - Dein Breitbandanschluss wieder für andere Opennet-Nutzer freigegeben. Du kannst während dieser Zeit selbstverständlich die Internet-Freigabe manuell reaktivieren.
</div>
<script type="text/javascript">
	document.getElementById('switch2').style.display='inline';
	document.getElementById('description2').style.display='none';
</script>
<!-- ************************************************************ -->
<FORM ACTION="on_ugws.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Vorübergehende Abschaltung der Internet-Unterverteilung">
<TBODY>
	<tr>
	<TD>Internet-Freigabe für
	<SELECT NAME="block_min" VALUE='30'>
	<OPTION VALUE='10'>10 Minuten</OPTION>
	<OPTION VALUE='20'>20 Minuten</OPTION>
	<OPTION VALUE='30' SELECTED="true">30 Minuten</OPTION>
	<OPTION VALUE='45'>45 Minuten</OPTION>
	<OPTION VALUE='60'>1 Stunde</OPTION>
	<OPTION VALUE='90'>1,5 Stunden</OPTION>
	<OPTION VALUE='120'>2 Stunden</OPTION>
	<OPTION VALUE='180'>3 Stunden</OPTION>
	<OPTION VALUE='240'>4 Stunden</OPTION>
	<OPTION VALUE='300'>5 Stunden</OPTION>
	<OPTION VALUE='360'>6 Stunden</OPTION>
	<OPTION VALUE='480'>8 Stunden</OPTION>
	<OPTION VALUE='600'>10 Stunden</OPTION>
	<OPTION VALUE='720'>12 Stunden</OPTION>
	<OPTION VALUE='960'>16 Stunden</OPTION>
	<OPTION VALUE='1200'>20 Stunden</OPTION>
	<OPTION VALUE='1440'>einen Tag</OPTION>
</SELECT>
	</TD>
	<TD><INPUT NAME="quick_block" TITLE="deaktivieren" TYPE="SUBMIT" VALUE="deaktivieren"></TD>
	</tr>
</TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
EOF
fi
cat<<EOF
<H2>Status</H2>
EOF
if [ -n "$on_share_internet_blocked" ]; then
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD><b>ACHTUNG:</b> Die Internet-Freigabe wurde vorübergehend deaktiviert. <b>In $on_share_internet_blocked Minuten</b> wird Dein Breitbandanschluss wieder <b>automatisch freigegeben</b>. Wenn Du die Internet-Freigabe wieder manuell aktivierst, wird die Deaktivierung sofort aufgehoben.</TD>
</TR>
</TBODY>
</TABLE>
<br />
EOF
fi
cat<<EOF

<!-- show the following area only, if user likes more information -->
<a id="switch3" href="#" onclick="document.getElementById('description3').style.display='inline';this.style.display='none';" style="display:none;">Erklärung</a>
<div id="description3">
<b>User-Gateway-Tunnel:</b> ist der Tunnel aktiv, teilst Du Deinen Internetzugang.
<br /><br />
<b>Internet-Freigabe möglich/nicht möglich:</b> Hier wird angezeigt, ob die Firmware auf dem AP einen Internetzugang am WAN-Anschluss erkannt hat, den Du teilen kannst. Dies wird stündlich geprüft, Du kannst den Test auch manuell starten. Wenn Du einen Breitbandzugang am WAN-Port angeschlossen hast, und hier angegeben wird, dass eine Freigabe nicht möglich ist, so solltest Du Dich im <a href="http://forum.on-i.de">Forum</a> melden, sehr wahrscheinlich sind nicht alle möglichen Verbindungsoptionen berücksichtigt worden.
<br /><br />
</div>
<script type="text/javascript">
	document.getElementById('switch3').style.display='inline';
	document.getElementById('description3').style.display='none';
</script>
<!-- ************************************************************ -->
<FORM ACTION="on_ugws.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Informationen zu User-Gateway-OpenVPN und nötigen Dateien">
<TBODY>
EOF
if [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ]; then
	if [ -f  /tmp/openvpn_ugw_msg.txt ];then
		echo "<tr><td></td><tr /><tr><td>User-Gateway-Tunnel aktiv</td><td> <img src=\"../images/yes.gif\" alt=\"yes\" style=\"vertical-align:middle;\"></td><td /></tr>"
	else
		if [ -f  /var/run/openvpn.opennet_ugw.pid ];then
			echo "<tr><td></td><tr /><tr><td>User-Gateway-Tunnel startend</td>"
			echo "<td> <img src=\"../images/no.gif\" alt=\"no\" style=\"vertical-align:middle;\"></td><td /></tr>"
		else
			echo "<tr><td></td><tr /><tr><td>User-Gateway-Tunnel nicht aktiv</td>"
			echo "<td> <img src=\"../images/no.gif\" alt=\"no\" style=\"vertical-align:middle;\"></td></tr>"
		fi	
	fi
fi
	if [ -n  "$(ip route show table 5)" ];then
cat<<EOF
	<tr>
	<td>Internet-Freigabe möglich </td>
	<td> <img src="../images/yes.gif" alt="yes" style="vertical-align:middle;"></td>
EOF
	else
cat<<EOF
	<tr>
	<td>Internet-Freigabe nicht möglich </td>
	<td> <img src="../images/no.gif" alt="no" style="vertical-align:middle;"></td>
EOF
	fi
cat<<EOF
	<TD><INPUT NAME="ugw_check" TITLE="check" TYPE="SUBMIT" VALUE="prüfen/starten"></TD>
	</tr>
EOF

if [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ]; then
	if [ "$on_share_internet" = "on" ];then
cat<<EOF
		<tr>
		<td>Internet-Freigabe aktiviert </td>
		<td> <img src="../images/yes.gif" alt="yes" style="vertical-align:middle;"></td>
		<TD><INPUT NAME="ugw_switch" TITLE="deaktivieren" TYPE="SUBMIT" VALUE="deaktivieren"></TD>
		</tr>
EOF
	else
cat<<EOF
		<tr>
		<td>Internet-Freigabe deaktiviert </td>
		<td> <img src="../images/no.gif" alt="no" style="vertical-align:middle;"></td>
		<TD><INPUT NAME="ugw_switch" TITLE="aktivieren" TYPE="SUBMIT" VALUE="aktivieren"></TD>
		</tr>
EOF
	fi
fi
cat<<EOF
</TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
<br /><br />
<FORM ACTION="on_ugws.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form"
TITLE="Informationen zu User-Gateway-OpenVPN und nötigen Dateien">
<TBODY>
EOF
if [ -f  /etc/openvpn/opennet_ugw/on_ugws.csr ];then
	echo "<tr><td>Zertifikatanfrage (CSR) vorhanden </td><td><img src=\"../images/yes.gif\" alt=\"yes\" style=\"vertical-align:middle;\"></td><td><a href="on_ugws.csr">herunterladen</a></td></tr>"
elif ! [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && ! [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ]; then
	echo "<tr><td>Zertifikatanfrage (CSR) fehlt </td><td></td></tr>"
fi
echo "<tr>"
if [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ];then
	echo "<td>Schlüssel vorhanden </td><td> <img src=\"../images/yes.gif\" alt=\"yes\" style=\"vertical-align:middle;\"></td><td><a href="on_ugws.key">herunterladen</a></td>"
else
	echo "<td>Schlüssel fehlt </td><td><img src=\"../images/no.gif\" alt=\"no\" style=\"vertical-align:middle;\"></td>"
fi
echo "</tr><tr>"
if [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ];then
	echo "<td>Zertifikat vorhanden </td><td><img src=\"../images/yes.gif\" alt=\"yes\" style=\"vertical-align:middle;\"></td><td><a href="on_ugws.crt">herunterladen</a></td>"
else
	echo "<td>Zertifikat fehlt </td><td><img src=\"../images/no.gif\" alt=\"no\" style=\"vertical-align:middle;\"></td>"
fi
cat<<EOF
</TR>

</TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
EOF
if [ -f  /etc/openvpn/opennet_ugw/on_ugws.csr ] && ! [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ]; then
	echo "Schicke die Zertifikatanfrage (CSR) <b> und nur diese Datei </b> an csr_ugw@opennet-initiative.de, um ein Zertifikat zu erhalten."
fi

cat<<EOF

<br />
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD><b>ACHTUNG:</b> Auf dieser Seite werden nur Schlüssel, Zertifikate und Anfragen für die Internet-Freigabe verwaltet. Die Konfiguration von OpenVPN für die Internet-Nutzung über Opennet findest du unter <a href="on_vpn.html">VPN Config</a>.</TD>
</TR>
</TBODY>
</TABLE>

<H2>User-Gateway-Tunnel Schlüssel-Verwaltung</H2>
EOF
	if ( [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ] ) || [ -z  "$(ip route show table 5)" ]; then
cat<<EOF
<a id="switch4" href="#" onclick="document.getElementById('vpn_upload_form').style.display='inline';this.style.display='none';" style="display:none;">anzeigen</a>
EOF
	fi
cat<<EOF
<FORM ID="vpn_upload_form" ACTION="on_ugws_upload.html" ENCTYPE="multipart/form-data" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="note"
TITLE="Wähle den Schlüssel (*.key) oder das Zertifikat (*.crt) zum hochladen aus">
<TBODY>
<TR>
<TD colspan="2">Zertifikat (*.crt) oder neuen geheimen Schlüssel (*.key) auf den Accesspoint laden</TD>
</TR>
<TR>
<TD><INPUT NAME="opensslfile" SIZE="32" TYPE="FILE" VALUE="Durchsuchen..."></TD>
<TD><INPUT NAME="post_opensslfile" TITLE="Die ausgewählte Datei wird übertragen und im Verzeichnis /etc/openvpn/opennet_ugw/ gespeichert" TYPE="SUBMIT" VALUE="Datei auf den Accesspoint laden"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>
EOF
	if ( [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ] ) || [ -z  "$(ip route show table 5)" ]; then
cat<<EOF
<script type="text/javascript">
	document.getElementById('switch4').style.display='inline';
	document.getElementById('vpn_upload_form').style.display='none';
</script>
EOF
	fi
cat<<EOF

<H2>User-Gateway-Tunnel Schlüssel-Erstellung</H2>
EOF
	if ( [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ] ) || [ -z  "$(ip route show table 5)" ]; then
cat<<EOF
<a id="switch5" href="#" onclick="document.getElementById('vpn_genkey_form').style.display='inline';this.style.display='none';" style="display:none;">anzeigen</a>
EOF
	fi
cat<<EOF

<FORM ID="vpn_genkey_form" ACTION="on_ugws.html" CLASS="form" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="note">
<TBODY>
<TR TITLE="Staat"><TD>Staat:</TD>
<TD><INPUT NAME="openssl_countryName" SIZE="48" TYPE="TEXT" VALUE="$openssl_countryName" $(if [ -n "$openssl_countryName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="Bundesland"><TD>Landesname:</TD>
<TD><INPUT NAME="openssl_provinceName" SIZE="48" TYPE="TEXT" VALUE="$openssl_provinceName" $(if [ -n "$openssl_provinceName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="Ort"><TD>Ort:</TD>
<TD><INPUT NAME="openssl_localityName" SIZE="48" TYPE="TEXT" VALUE="$openssl_localityName" $(if [ -n "$openssl_localityName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="pers. Name"><TD>eigener Name:</TD>
<TD><INPUT NAME="openssl_organizationName" SIZE="48" TYPE="TEXT" VALUE="*** bitte Namen eintragen ***" $(if [ -n "$openssl_organizationName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="Nutzergruppe"><TD>Nutzergruppe:</TD>
<TD><INPUT NAME="openssl_organizationalUnitName" SIZE="48" TYPE="TEXT" VALUE="$openssl_organizationalUnitName" $(if [ -n "$openssl_organizationalUnitName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="accesspunkt-name"><TD>User-Gateway-Name:</TD>
<TD><INPUT NAME="openssl_commonName" SIZE="48" TYPE="TEXT" VALUE="$(nvram get wifi_ipaddr | cut -d'.' -f4).ugw.on" $(if [ -n "$openssl_commonName" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<TR TITLE="email adresse"><TD>email-adresse:</TD>
<TD><INPUT NAME="openssl_EmailAddress" SIZE="48" TYPE="TEXT" VALUE="ap$(nvram get wifi_ipaddr | cut -d'.' -f4)@opennet-initiative.de" $(if [ -n "$openssl_EmailAddress" ];then echo ' disabled="disabled"';fi)></TD>
</TR>
<tr><td></td></tr>
<TR
TITLE="Geheimer Schlüssel und Anfrage zur Zertifizierung wird generiert">
<TD colspan="2">Geheimen Schlüssel und Anfrage zur Zertifizierung (CSR) generieren:</TD>
<TD><INPUT NAME="gen_csr" TITLE="Secret Key und Request jetzt generieren" TYPE="SUBMIT" VALUE=" Generieren"></TD>
</TR>
<TR><td></td></TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>


EOF
	if ( [ -f  /etc/openvpn/opennet_ugw/on_ugws.key ] && [ -f /etc/openvpn/opennet_ugw/on_ugws.crt ] ) || [ -z  "$(ip route show table 5)" ]; then
cat<<EOF
<script type="text/javascript">
	document.getElementById('switch5').style.display='inline';
	document.getElementById('vpn_genkey_form').style.display='none';
</script>
EOF
	fi

else
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
DIRTY=

if [ -n "$quick_block" ]; then
	nvram set on_share_internet_blocked=$block_min
	nvram set on_share_internet="off"
	nvram commit
	/etc/init.d/S80openvpn stop opennet_ugw >/dev/null
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD>Die Freigabe Deines Internetzugangs wurde deaktiviert und wird automatisch in $block_min Minuten neu gestartet.</TD>
	</TR></TBODY>
	</TABLE>
EOF
elif [ -n "$ugw_start" ]; then
	/usr/sbin/check_usergateway.sh
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY><TR><TD>
Versuch, einen Tunnel zum externen Gateway aufzubauen, gestartet.
<TD></TR></TBODY>
</TABLE>
EOF
elif [ -n "$gen_csr" ]; then
	if [ -f /etc/openvpn/opennet_ugw/on_ugws.key ] || [ -f /etc/openvpn/opennet_ugw/on_ugws.csr ]; then
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>
EOF
	echo "<H1>"
		if [ -f /etc/openvpn/opennet_ugw/on_ugws.key ]; then
			echo "Geheimer Schlüssel (Datei on_ugws.key im Verzeichnis /etc/openvpn/opennet_ugw/) auf dem Accesspoint schon vorhanden.<br>"
		fi
		if [ -f /etc/openvpn/opennet_ugw/on_ugws.csr ]; then
			echo "Anfrage zur Zertifizierung (Datei on_ugws.csr im Verzeichnis /etc/openvpn/opennet_ugw/) auf dem Accesspoint schon vorhanden.<br>"
		fi
		echo "Was soll ich machen?<br>"
	echo "</H1>"
cat<<EOF
<FORM ACTION="on_ugws.html" METHOD="POST">
<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form">
<TBODY>
<TR>
<TD>
Ein neuer Key, verbunden mit einer Anfrage zur Zertifizierung kann nur erstellt werden,
wenn der vorhandene Key bzw. die vorhandene Anfrage zur Zertifizierung gelöscht wird/werden.
Dies sollte nur in wenigen Fällen nötig sein.
Wenn Du den geheimen Schlüssel vorher nicht heruntergeladen hast, ist dieser <B>unwiederbringlich verloren</B>,
das Zertifikat, sofern du es schon beantragt hast, wertlos.
Soll der geheime Schlüssel und/oder die Anfrage zur Zertifizierung gelöscht werden?
EOF
if [ -f  /etc/openvpn/opennet_ugw/on_ugws.crt ]; then
	echo " (Da das aufgespielte Zertifkat dann auch nicht mehr zum neuen Schlüssel passt, wird dieses gleichfalls gelöscht)"
fi
cat<<EOF
</TD>
</TR>
<TR>
<TD COLSPAN="2"><INPUT NAME="remove_key_csr" TITLE="vorhandene Datei(-en) löschen" TYPE="SUBMIT" VALUE="vorhandene Datei(-en) löschen">   <INPUT NAME="upload_abort" TITLE="Abbruch" TYPE="SUBMIT" VALUE="Abbruch"></TD>
</TR></TBODY>
</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></FORM>

</TR></TBODY>
</TABLE>
EOF
	else
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Erzeuge geheimen Schlüssel und Anfrage für Unterzeichnung (CSR). Bitte warten...</TD>
</TR></TBODY>
</TABLE>
EOF
echo "<pre>"

openssl_countryName="de"
openssl_provinceName="Mecklenburg-Vorpommern"
openssl_localityName="Rostock"
openssl_organizationalUnitName="user gateways"

openssl_countryName=$(unescape "$openssl_countryName"); export openssl_countryName
openssl_provinceName=$(unescape "$openssl_provinceName"); export openssl_provinceName
openssl_localityName=$(unescape "$openssl_localityName"); export openssl_localityName
openssl_organizationName=$(unescape "$openssl_organizationName"); export openssl_organizationName
openssl_organizationalUnitName=$(unescape "$openssl_organizationalUnitName"); export openssl_organizationalUnitName
openssl_commonName=$(unescape "$openssl_commonName"); export openssl_commonName
openssl_EmailAddress=$(unescape "$openssl_EmailAddress"); export openssl_EmailAddress

openssl req -days 3650 -nodes -new -keyout /etc/openvpn/opennet_ugw/on_ugws.key -out /etc/openvpn/opennet_ugw/on_ugws.csr

return_value=$?

#openssl req -noout -text -in /etc/openvpn/opennet_ugw/on_ugws.csr



echo "</pre>"
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD>
EOF
if [ $return_value = 0 ]; then
	echo "Schlüssel und CSR-Erstellung erfolgreich abgeschlossen."
	# blockiere Webfrontend zum Firmware-Update
	if ! [ -e /www/cgi-bin/webif/$upgrade_bak ]; then
		mv -f /www/cgi-bin/webif/$upgrade /www/cgi-bin/webif/$upgrade_bak 2>/dev/null
		ln -s /www/cgi-bin/webif/upgrade.sh_on /www/cgi-bin/webif/$upgrade 2>/dev/null
	fi
else
	echo "Schlüssel und CSR-Erstellung <b>fehlgeschlagen</b>"
fi
cat<<EOF
	</TD>
	</TR></TBODY>
	</TABLE>
EOF
fi
elif [ -n "$upload_force" ]; then
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>
EOF
	if [ -f /tmp/on_ugws_upload.key ]; then
		mv /etc/openvpn/opennet_ugw/on_ugws.key /etc/openvpn/opennet_ugw/on_ugws.key_bak
		echo "geheimer Schlüssel /etc/openvpn/opennet_ugw/on_ugws.key wurde durch die hochgeladene Datei überschrieben"
		mv /tmp/on_ugws_upload.key /etc/openvpn/opennet_ugw/on_ugws.key
		rm /etc/openvpn/opennet_ugw/on_ugws.key_bak
		# blockiere Webfrontend zum Firmware-Update
		if ! [ -e /www/cgi-bin/webif/$upgrade_bak ]; then
			mv -f /www/cgi-bin/webif/$upgrade /www/cgi-bin/webif/$upgrade_bak 2>/dev/null
			ln -s /www/cgi-bin/webif/upgrade.sh_on /www/cgi-bin/webif/$upgrade 2>/dev/null
		fi
	elif [ -f /tmp/on_ugws_upload.crt ]; then
		mv  /etc/openvpn/on_ugws.crt /etc/openvpn/opennet_ugw/on_ugws.crt_bak
		echo "Zertifikat /etc/openvpn/opennet_ugw/on_ugws.crt wurde durch die hochgeladene Datei überschrieben"
		mv /tmp/on_ugws_upload.crt /etc/openvpn/opennet_ugw/on_ugws.crt
		rm /etc/openvpn/opennet_ugw/on_ugws.crt_bak
	fi
cat<<EOF
</TD>
</TR></TBODY>
</TABLE>
EOF
elif [ -n "$remove_key_csr" ]; then
rm -f /etc/openvpn/opennet_ugw/on_ugws.csr
rm -f /etc/openvpn/opennet_ugw/on_ugws.key
rm -f /etc/openvpn/opennet_ugw/on_ugws.crt
# reaktiviere Webfrontend zum Firmware-Update
if ! [ -f /etc/openvpn/opennet_user/on_aps.key ]; then
	mv -f /www/cgi-bin/webif/$upgrade_bak /www/cgi-bin/webif/$upgrade 2>/dev/null
fi
cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Datei(-en) wurden gelöscht. Nun kann ein neuer geheimer Key generiert werden.</TD>
</TR></TBODY>
</TABLE>
EOF
elif [ -n "$ugw_check" ]; then
	check_usergateway.sh >/dev/null
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD>
	Test wurde durchgeführt. Die Ergebnisse siehst Du wieder auf der <a href="on_ugws.html">Internet-Freigabe</a>- Seite. Das kann durchaus noch etwas (~1min.) dauern.
	</TD>
	</TR></TBODY>
	</TABLE>
EOF
elif [ -n "$ugw_switch" ]; then
	on_share_internet="$(nvram get on_share_internet)"
	if [ "$on_share_internet" = "on" ]; then
		on_share_internet="off"
		/etc/init.d/S80openvpn stop opennet_ugw >/dev/null
	else
		on_share_internet="on"
		/etc/init.d/S80openvpn stop opennet_ugw >/dev/null
		nvram unset on_share_internet_blocked
	fi
	nvram set on_share_internet="$on_share_internet"
	nvram commit
	if [ "$on_share_internet" = "on" ]; then /etc/init.d/S80openvpn start opennet_ugw >/dev/null; fi
cat<<EOF
	<TABLE BORDER="0" CLASS="note">
	<TBODY>
	<TR>
	<TD>
EOF
	if [ "$on_share_internet" = "off" ]; then
		echo "Internet-Freigabe wurde deaktiviert."
	else
		echo "Internet-Freigabe wurde aktiviert."
	fi
cat<<EOF
	</TD>
	</TR></TBODY>
	</TABLE>
EOF
elif [ -n "$upload_abort" ]; then

cat<<EOF
<TABLE BORDER="0" CLASS="note">
<TBODY>
<TR>
<TD>Es wurden keine Einstellungen ge&auml;ndert.</TD>
</TR></TBODY>
</TABLE>
EOF


fi
fi

. ${0%/*}/cgi-bin-post.sh
