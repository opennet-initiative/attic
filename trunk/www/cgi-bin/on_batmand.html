#!/bin/sh

export DATE="15.11.2007"
export TITLE="Verwaltung: B.A.T.M.A.N."
. ${0%/*}/cgi-bin-pre.sh


if [ "$REQUEST_METHOD" = "POST" ]; then
	read QUERY_STRING
fi
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
if [ -n "$post_on_batmand" ]; then
	eval "C=\$on_batman"
	C=$(unescape $C)
	if [ "$C" = "on" ]; then
		if [ "$(nvram get on_batman)" != "true" ]; then
			nvram set on_batman="true"; DIRTY=1
			/etc/init.d/S54batmand restart
		fi
	else
		if [ -n "$(nvram get on_batman)" ]; then
			nvram unset on_batman; DIRTY=1
			/etc/init.d/S54batmand stop
		fi
	fi
	if [ -n "$DIRTY" ]; then nvram commit>/dev/null 2>&1; fi
	if [ -n "$DIRTY" ]; then
		msg="Die ge&auml;nderten Einstellungen wurden &uuml;bernommen. Die Einstellungen sind sofort aktiv."
	fi
fi
cat<<EOF

<script type="text/javascript">document.getElementById('idx43').className="idx selected";</script>

	<H1>Verwaltung: B.A.T.M.A.N.</H1>
Hier kann B.A.T.M.A.N. aktiviert werden, ein neues Routing-Protokoll, welches Testweise parallel auf dem AccessPoint laufen kann.
<!-- show the following area only, if user likes more information -->
<a id="switch" href="#" onclick="document.getElementById('description').style.display='inline';this.style.display='none';" style="display:none;">mehr...</a>
<div id="description">
Die Nutzung von B.A.T.M.A.N. kann als Test parallel zu OLSR, dem aktuellen Routing-Protokoll aktiviert werden. Durch eine Beteiligung an diesem Test kannst Du helfen, das Routing, also die Bestimmung der Wege, die ein Paket im opennet nimmt, zu verbessern. Adressen im Netz 192.168.42.0/23, also Adressen der Art 192.168.42.X (AccessPoints) oder 192.168.43.X (Gateways) gehören zum B.A.T.M.A.N.-Netz. Dein AP hat in diesem Netz zusätzlich zur Addresse $(nvram get wifi_ipaddr) die Addresse $(nvram get wifi_ipaddr | cut -d'.' -f1,2).42.$(nvram get wifi_ipaddr | cut -d'.' -f4). Wenn Du Deinen AccessPoint mit einer Testadresse (192.168.33.X) betreibst, ist B.A.T.M.A.N. deaktiviert.</div>
<script type="text/javascript">
	document.getElementById('switch').style.display='inline';
	document.getElementById('description').style.display='none';
</script>
<!-- ************************************************************ -->
EOF
	if [ ! -e /usr/sbin/batmand ]; then
cat<<EOF
<br /><br /><b>HINWEIS: </b> Wenn du B.A.T.M.A.N. testen willst, musst Du das <a href="webif/ipkg.sh?action=install&amp;pkg=batmand">Paket batmand installieren</a> (link startet Installation). Ist dieses nicht verfügbar, musst Du vorher die <a href="webif/ipkg.sh?action=update">Liste der verfügbaren Pakete aktualisieren</a>.<br />
<br />
EOF
		if [ "$(nvram get on_batman)" = "true" ]; then
			nvram unset on_batman; nvram commit
		fi
	else
cat<<EOF
	<FORM NAME="batman" ACTION="on_batmand.html" CLASS="form" METHOD="POST">
	<TABLE CLASS="shadow0" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow1" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE CLASS="shadow2" CELLPADDING="0" CELLSPACING="0"><TR><TD><TABLE BORDER="0" CLASS="form">
	<TBODY>
	<TR><TD>
	<INPUT CLASS="checkbox" NAME="on_batman" TYPE="checkbox" $(test "$(nvram get on_batman)" = "true" && echo "CHECKED='CHECKED'" && echo "VALUE='on'")"></TD>
	<TD colspan="2">B.A.T.M.A.N. aktivieren
	</TD></TR>
	<TR>
<TD> </TD><TD colspan="2"><INPUT NAME="post_on_batmand" TITLE="Einstellungen übernehmen" TYPE="SUBMIT" VALUE="übernehmen"></TD>
</TR>
	</TBODY>
	</TABLE></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE>
	</FORM>
EOF
	fi
. ${0%/*}/cgi-bin-post.sh
